name: expressions
categories:
- expressions
tests:
- name: atoms
  categories:
  - atoms
  tests:
  - script: '1'
    result: 1
  - script: '-2'
    result: -2
  - script: '3.0'
    result: 3.0
  - script: '-4.5'
    result: -4.5
  - script: '{-}'
    result:
      _class: NewBag
  - script: '{ - }'
    result:
      _class: NewBag
  - script: "'test'"
    result:
      _class: StringLiteral
      value: 'test'
  - script: "'test\\'s'"
    result:
      _class: StringLiteral
      value: "test's"
  - script: "'test\\ntest'"
    result:
      _class: StringLiteral
      value: "test\ntest"
  - script: "'test\ntest'"
    result:
      _class: StringLiteral
      value: "test\ntest"

- name: special_references
  categories:
  - special_references
  - references
  tests:
  - script: '?'
    result:
      _class: SpecialReference
      value: 'SUBJECT'
  - script: '~'
    result:
      _class: SpecialReference
      value: 'ROOT'
  - script: '!'
    result:
      _class: SpecialReference
      value: 'NONE'

- name: math
  categories:
  - math
  tests:
  - script: '1 + 1'
    result: 2
  - script: '1 + a'
    result:
      _class: BinaryOp
      left: 1
      op: '+'
      right:
        _class: Reference
        value: a
  - script: 'a - 1'
    result:
      _class: BinaryOp
      left:
        _class: Reference
        value: a
      op: '-'
      right: 1
  - script: 'a - -1'
    result:
      _class: BinaryOp
      left:
        _class: Reference
        value: a
      op: '-'
      right: -1
  - script: 'a * 3'
    result:
      _class: BinaryOp
      left:
        _class: Reference
        value: a
      op: '*'
      right: 3
  - script: '3 % a'
    result:
      _class: BinaryOp
      left: 3
      op: '%'
      right:
        _class: Reference
        value: a
  - script: 'a / 1'
    result:
      _class: BinaryOp
      left:
        _class: Reference
        value: a
      op: '/'
      right: 1
  - script: '4 %/ a'
    result:
      _class: BinaryOp
      left: 4
      op: '%/'
      right:
        _class: Reference
        value: a

- name: order_of_operations
  categories:
  - math
  tests:
  - script: '1 + a * 3'
    result:
      _class: BinaryOp
      left: 1
      op: '+'
      right:
        _class: BinaryOp
        left:
          _class: Reference
          value: a
        op: '*'
        right: 3
  - script: '4 * b + 6'
    result:
      _class: BinaryOp
      left:
        _class: BinaryOp
        left: 4
        op: '*'
        right:
          _class: Reference
          value: b
      op: '+'
      right: 6

- name: roll_math
  categories:
  - math
  tests:
  - script: 'test & 2'
    result:
      _class: BinaryOp
      left:
        _class: Reference
        value: 'test'
      op: '&'
      right: 2
  - script: 'test ^ 2'
    result:
      _class: BinaryOp
      left:
        _class: Reference
        value: 'test'
      op: '^'
      right: 2
  - script: 'test ^ 2 + c'
    result:
      _class: BinaryOp
      left:
        _class: Reference
        value: 'test'
      op: '^'
      right:
        _class: BinaryOp
        left: 2
        op: '+'
        right:
          _class: Reference
          value: c
  - script: 'test ^ 2 * c'
    result:
      _class: BinaryOp
      left:
        _class: Reference
        value: 'test'
      op: '^'
      right:
        _class: BinaryOp
        left: 2
        op: '*'
        right:
          _class: Reference
          value: c
  - script: '1 ^ test & c'
    result:
      _class: BinaryOp
      left: 1
      op: '^'
      right:
        _class: BinaryOp
        left:
          _class: Reference
          value: 'test'
        op: '&'
        right:
          _class: Reference
          value: c
  - script: '(test ^ 2) & c'
    result:
      _class: BinaryOp
      left:
        _class: BinaryOp
        left:
          _class: Reference
          value: 'test'
        op: '^'
        right: 2
      op: '&'
      right:
        _class: Reference
        value: c

- name: dice
  categories:
  - dice
  tests:
  - script: '1d6'
    result:
      _class: DiceNode
      number_of_dice: 1
      sides: 6
  - script: '1 + 2d3'
    result:
      _class: BinaryOp
      left: 1
      op: '+'
      right:
        _class: DiceNode
        number_of_dice: 2
        sides: 3
  - script: '2d3 * 4'
    result:
      _class: BinaryOp
      left:
        _class: DiceNode
        number_of_dice: 2
        sides: 3
      op: '*'
      right: 4
  - script: '(1+a)d3'
    result:
      _class: DiceNode
      number_of_dice:
        _class: BinaryOp
        left: 1
        op: '+'
        right:
          _class: Reference
          value: a
      sides: 3
  - script: '1d(a *3)'
    result:
      _class: DiceNode
      number_of_dice: 1
      sides:
        _class: BinaryOp
        left:
          _class: Reference
          value: a
        op: '*'
        right: 3
  - script: '(1d6)d4'
    result:
      _class: DiceNode
      number_of_dice:
        _class: DiceNode
        number_of_dice: 1
        sides: 6
      sides: 4
  - script: '2d(3d4)'
    result:
      _class: DiceNode
      number_of_dice: 2
      sides:
        _class: DiceNode
        number_of_dice: 3
        sides: 4
  - script: '(7d3)d(2d5)'
    result:
      _class: DiceNode
      number_of_dice:
        _class: DiceNode
        number_of_dice: 7
        sides: 3
      sides:
        _class: DiceNode
        number_of_dice: 2
        sides: 5

- name: reduce
  categories:
  - reduce
  tests:
  - script: '{?}'
    result:
      _class: Reduce
      value:
        _class: SpecialReference
        value: 'SUBJECT'
  - script: '{1d6}'
    result:
      _class: Reduce
      value:
        _class: DiceNode
        number_of_dice: 1
        sides: 6
  - script: '{1d6 +2}'
    result:
      _class: Reduce
      value:
        _class: BinaryOp
        left:
          _class: DiceNode
          number_of_dice: 1
          sides: 6
        op: '+'
        right: 2
  - script: '{1d6} +2'
    result:
      _class: BinaryOp
      left:
        _class: Reduce
        value:
          _class: DiceNode
          number_of_dice: 1
          sides: 6
      op: '+'
      right: 2
  - script: '{test}.attr'
    result:
      _class: Access
      accessing:
        _class: Reduce
        value:
          _class: Reference
          value: 'test'
      accessors:
      - _class: Reference
        value: 'attr'
  - script: '{1d{2d4}}'
    result:
      _class: Reduce
      value:
        _class: DiceNode
        number_of_dice: 1
        sides:
          _class: Reduce
          value:
            _class: DiceNode
            number_of_dice: 2
            sides: 4
  - script: '{1}->top'
    result:
      _class: Modify
      subject:
        _class: Reduce
        value: 1
      modifiers:
      - _class: ModifierCall
        modifier:
          _class: Reference
          value: 'top'
        args: []
  - script: '{1d4}->top'
    result:
      _class: Modify
      subject:
        _class: Reduce
        value:
          _class: DiceNode
          number_of_dice: 1
          sides: 4
      modifiers:
      - _class: ModifierCall
        modifier:
          _class: Reference
          value: 'top'
        args: []
  - script: '{1d{2d4}}->top'
    result:
      _class: Modify
      subject:
        _class: Reduce
        value:
          _class: DiceNode
          number_of_dice: 1
          sides:
            _class: Reduce
            value:
              _class: DiceNode
              number_of_dice: 2
              sides: 4
      modifiers:
      - _class: ModifierCall
        modifier:
          _class: Reference
          value: 'top'
        args: []
  - script: '{1}'
    result:
      _class: Reduce
      value: 1
  - script: '{1 + a}'
    result:
      _class: Reduce
      value:
        _class: BinaryOp
        left: 1
        op: '+'
        right:
          _class: Reference
          value: a
  - script: '{3 * a - 4}'
    result:
      _class: Reduce
      value:
        _class: BinaryOp
        left:
          _class: BinaryOp
          left: 3
          op: '*'
          right:
            _class: Reference
            value: a
        op: '-'
        right: 4
  - script: '{3 * (a - 4)}'
    result:
      _class: Reduce
      value:
        _class: BinaryOp
        left: 3
        op: '*'
        right:
          _class: BinaryOp
          left:
            _class: Reference
            value: a
          op: '-'
          right: 4
  - script: '{3 * {a - 4}}'
    result:
      _class: Reduce
      value:
        _class: BinaryOp
        left: 3
        op: '*'
        right:
          _class: Reduce
          value:
            _class: BinaryOp
            left:
              _class: Reference
              value: a
            op: '-'
            right: 4

- name: enlarge
  categories:
  - enlarge
  tests:
  - script: '{@}'
    result:
      _class: Enlarge
      size: null
      value: null
  - script: '{1@}'
    result:
      _class: Enlarge
      size: 1
      value: null
  - script: '{@2}'
    result:
      _class: Enlarge
      size: null
      value: 2
  - script: '{1@2}'
    result:
      _class: Enlarge
      size: 1
      value: 2
  - script: '{1d6@2d3}'
    result:
      _class: Enlarge
      size:
        _class: DiceNode
        number_of_dice: 1
        sides: 6
      value:
        _class: DiceNode
        number_of_dice: 2
        sides: 3
  - script: '{1d6@{2d3}}'
    result:
      _class: Enlarge
      size:
        _class: DiceNode
        number_of_dice: 1
        sides: 6
      value:
        _class: Reduce
        value:
          _class: DiceNode
          number_of_dice: 2
          sides: 3
#  - script: '{}'
#    result:
#      _class: Enlarge
#      value:

- name: access
  categories:
  - access
  tests:
  - script: 'test.test2'
    result:
      accessing:
        _class: Reference
        value: 'test'
      accessors:
      - _class: Reference
        value: 'test2'
  - script: 'test.test2.test3'
    result:
      accessing:
        _class: Reference
        value: 'test'
      accessors:
      - _class: Reference
        value: 'test2'
      - _class: Reference
        value: 'test3'
  - script: 'test.{name}'
    result:
      accessing:
        _class: Reference
        value: 'test'
      accessors:
      - _class: Reduce
        value:
          _class: Reference
          value: 'name'
  - script: 'test.{3}'
    result:
      accessing:
        _class: Reference
        value: 'test'
      accessors:
      - _class: Reduce
        value: 3
  - script: 'test.{1}.name.{test}'
    result:
      accessing:
        _class: Reference
        value: 'test'
      accessors:
      - _class: Reduce
        value: 1
      - _class: Reference
        value: 'name'
      - _class: Reduce
        value:
          _class: Reference
          value: 'test'
  - script: 'test.{#}'
    result:
      accessing:
        _class: Reference
        value: 'test'
      accessors:
      - _class: SpecialAccessor
        value: LENGTH
  - script: 'test.{+}'
    result:
      accessing:
        _class: Reference
        value: 'test'
      accessors:
      - _class: SpecialAccessor
        value: TOTAL
  - script: 'test.{=}'
    result:
      accessing:
        _class: Reference
        value: 'test'
      accessors:
      - _class: SpecialAccessor
        value: VALUE
  - script: 'test.{*}'
    result:
      accessing:
        _class: Reference
        value: 'test'
      accessors:
      - _class: SpecialAccessor
        value: EVERY
